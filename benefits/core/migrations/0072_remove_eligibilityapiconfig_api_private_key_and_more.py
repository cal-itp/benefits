# Generated by Django 5.2.7 on 2026-01-15 20:50

import django.db.models.deletion
from django.db import migrations, models


def migrate_eligibility_api_config_data(apps, schema_editor):
    EligibilityApiConfig = apps.get_model("core", "EligibilityApiConfig")
    EligibilityApiVerificationRequest = apps.get_model("core", "EligibilityApiVerificationRequest")

    eligibility_api_config = EligibilityApiConfig.objects.first()

    for request in EligibilityApiVerificationRequest.objects.all():
        request.api_client_private_key = eligibility_api_config.api_private_key
        request.api_client_public_key = eligibility_api_config.api_public_key
        request.save()


def delete_eligibility_api_config_instances(apps, schema_editor):
    EligibilityApiConfig = apps.get_model("core", "EligibilityApiConfig")

    for config in EligibilityApiConfig.objects.all():
        config.delete()


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0071_remove_enrollmentflow_selection_label_template_override"),
    ]

    operations = [
        migrations.AddField(
            model_name="eligibilityapiverificationrequest",
            name="api_client_private_key",
            field=models.ForeignKey(
                default=None,
                help_text="Private key used to sign Eligibility API tokens created on behalf of the Benefits client.",
                null=True,
                on_delete=django.db.models.deletion.PROTECT,
                related_name="+",
                to="core.pemdata",
            ),
        ),
        migrations.AddField(
            model_name="eligibilityapiverificationrequest",
            name="api_client_public_key",
            field=models.ForeignKey(
                default=None,
                help_text=(
                    "Public key corresponding to the Benefits client's private key, used by "
                    "Eligibility Verification servers to encrypt responses."
                ),
                null=True,
                on_delete=django.db.models.deletion.PROTECT,
                related_name="+",
                to="core.pemdata",
            ),
        ),
        migrations.RunPython(migrate_eligibility_api_config_data),
        migrations.RemoveField(
            model_name="eligibilityapiconfig",
            name="api_private_key",
        ),
        migrations.RemoveField(
            model_name="eligibilityapiconfig",
            name="api_public_key",
        ),
        migrations.RemoveField(
            model_name="eligibilityapiconfig",
            name="api_id",
        ),
        migrations.RemoveField(
            model_name="transitagency",
            name="eligibility_api_config",
        ),
        migrations.RunPython(delete_eligibility_api_config_instances),
        migrations.DeleteModel(
            name="EligibilityApiConfig",
        ),
    ]
