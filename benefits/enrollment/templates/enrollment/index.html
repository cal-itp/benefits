{% extends "core/base.html" %}
{% load i18n %}

{% block page-title %}
  {% translate "Eligibility confirmation" %}
{% endblock page-title %}

{% block nav-buttons %}
  {% if authentication and authentication.sign_out_link_template %}
    {% include authentication.sign_out_link_template %}
  {% endif %}
{% endblock nav-buttons %}

{% block headline %}
  <div class="col-lg-8">
    <h1 class="pb-lg-8 pb-4">
      {% translate "Your eligibility is confirmed!<br>Youâ€™re nearly there." %}
    </h1>
  </div>
{% endblock headline %}

{% block inner-content %}
  <div class="col-12 col-sm-12 col-lg-8">
    <ul class="media-list mx-0 px-0 d-flex justify-content-center flex-column">
      {% include "enrollment/includes/media-item--bankcardcheck--index.html" %}
    </ul>
  </div>
  {% comment %}
    This Javascript code is partially generated by this template and so it must
    come before the forms, which are rendered at just before the {% endblock inner-content %}
  {% endcomment %}
  {% url "enrollment:token" as access_token_url %}
  {% translate "Please wait..." as loading_text %}
  <script nonce="{{ request.csp_nonce }}">
      var startedEvent = "started payment connection", closedEvent = "closed payment connection";

      $.ajax({ dataType: "script", attrs: { nonce: "{{ request.csp_nonce }}"}, url: "{{ card_tokenize_url }}" })
          .done(function() {
          $.get("{{ access_token_url }}", function(data) {
              $(".loading").remove();
              $(".invisible").removeClass("invisible");

              $("#{{ cta_button }}").on("click", function() {
                  amplitude.getInstance().logEvent(startedEvent, {
                      card_tokenize_url: "{{ card_tokenize_url }}",
                      card_tokenize_func: "{{ card_tokenize_func }}"
                  });
                  $(this).addClass("disabled").attr("aria-disabled", "true").text("{{ loading_text }}");
              });

              {{ card_tokenize_func }}({
                  authorization: data.token,
                  element: '#{{ cta_button }}',
                  envUrl: '{{ card_tokenize_env }}',
                  options: {
                      color: '#046b99'
                  },
                  onTokenize: function (response) {
                      /* This function executes when the
                      /* card verification returns
                      /* successfully with a token from enrollment server */
                      amplitude.getInstance().logEvent(closedEvent, {status: "success"});

                      var form = $("form#{{ form_success }}");
                      $("#{{ token_field }}", form).val(response.token);
                      form.submit();
                  },
                  onVerificationFailure: function (response) {
                      /* This function executes when the
                      /* card verification fails and server
                      /* return verification failure message */
                      amplitude.getInstance().logEvent(closedEvent, {status: "fail"});

                      var form = $("form#{{ form_retry }}");
                      form.submit();
                  },
                  onError: function (response) {
                      /* This function executes when the
                      /* server returns error or token is invalid.
                      /* 400 or 500 will return. */
                      amplitude.getInstance().logEvent(closedEvent, {status: "error", error: response});

                      var form = $("form#{{ form_retry }}");
                      form.submit();
                  },
                  onCancel: function () {
                      /* This function executes when the
                      /* user cancels and closes the window
                      /* and returns to home page. */
                      amplitude.getInstance().logEvent(closedEvent, {status: "cancel"});

                      return location.reload();
                  }
              });
          });
      })
      .fail(function(jqxhr, settings, exception) {
        $(".loading").remove();
        console.log(exception);
      });
  </script>

  {% for f in forms %}
    {% include "core/includes/form.html" with form=f %}
  {% endfor %}
{% endblock inner-content %}

{% block call-to-action-button %}
  <button type="button" class="btn btn-primary btn-lg loading" role="status" disabled>{% translate "Please wait..." %}</button>
  <div class="invisible">
    <button id="{{ cta_button }}" href="#{{ cta_button }}" class="btn btn-lg btn-primary" role="button">
      {% translate "Connect your Card" %}
    </button>
  </div>
{% endblock call-to-action-button %}
