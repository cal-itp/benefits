{% extends "core/base.html" %}
{% load i18n %}

{% block page-title %}
  {% translate "Eligibility confirmation" %}
{% endblock page-title %}

{% block nav-buttons %}
  {% if authentication and authentication.sign_out_link_template %}
    {% include authentication.sign_out_link_template %}
  {% endif %}
{% endblock nav-buttons %}

{% block headline %}
  <div class="col-lg-8">
    <h1 class="pb-lg-8 pb-4">
      {% translate "Your eligibility is confirmed!<br>Youâ€™re almost there." %}
    </h1>
  </div>
{% endblock headline %}

{% block inner-content %}
  {% block media-items %}
    <div class="col-12 col-sm-12 col-lg-8">
      <ul class="d-flex list-unstyled ps-0 pb-5 mb-3">
        {% include "enrollment/includes/media-item--contactless-card--index.html" %}
      </ul>
    </div>
  {% endblock media-items %}
  {% block additional-info %}
  {% endblock additional-info %}
  {% comment %}
    This Javascript code is partially generated by this template and so it must
    come before the forms, which are rendered at just before the {% endblock inner-content %}
  {% endcomment %}
  {% translate "Please wait..." as loading_text %}
  <script nonce="{{ request.csp_nonce }}">
      var startedEvent = "started card tokenization", closedEvent = "finished card tokenization";

      $.ajax({ dataType: "script", attrs: { nonce: "{{ request.csp_nonce }}"}, url: "{{ card_tokenize_url }}" })
          .done(function() {
          $.get("{% url routes.ENROLLMENT_TOKEN %}", function(data) {
              if (data.redirect) {
                // https://stackoverflow.com/a/42469170
                // use 'assign' because 'replace' was giving strange Back button behavior
                window.location.assign(data.redirect);
                return; // exit early so the rest of this function doesn't execute
              }

              $(".loading").remove();
              // remove invisible and add back visible, so we aren't left with
              // a div with an empty class attribute
              // (this is purely for clarity when reviewing the HTML, no UX impact)
              $(".invisible").removeClass("invisible").addClass("visible");

              $("#{{ cta_button }}").on("click", function() {
                  amplitude.getInstance().logEvent(startedEvent, {
                      card_tokenize_url: "{{ card_tokenize_url }}",
                      card_tokenize_func: "{{ card_tokenize_func }}",
                      enrollment_method: "{{ enrollment_method }}"
                  });
                  $(this).addClass("disabled").attr("aria-disabled", "true").text("{{ loading_text }}");
              });

              {{ card_tokenize_func }}({
                  authorization: data.token,
                  element: '#{{ cta_button }}',
                  envUrl: '{{ card_tokenize_env }}',
                  options: {
                      color: '#046b99',
                      language: '{{ overlay_language }}'
                  },
                  onTokenize: function (response) {
                      /* This function executes when the
                      /* card verification returns
                      /* successfully with a token from enrollment server */
                      amplitude.getInstance().logEvent(closedEvent, {status: "success", enrollment_method: "{{ enrollment_method }}"});

                      var form = $("form#{{ form_success }}");
                      $("#{{ token_field }}", form).val(response.token);
                      form.submit();
                  },
                  onVerificationFailure: function (response) {
                      /* This function executes when the
                      /* card verification fails and server
                      /* return verification failure message */
                      amplitude.getInstance().logEvent(closedEvent, {status: "fail", enrollment_method: "{{ enrollment_method }}"});

                      var form = $("form#{{ form_retry }}");
                      form.submit();
                  },
                  onError: function (response) {
                      /* This function executes when the
                      /* server returns error or token is invalid.
                      /* 400 or 500 will return. */
                      amplitude.getInstance().logEvent(closedEvent, {status: "error", error: response, enrollment_method: "{{ enrollment_method }}"});

                      if (response.status >= 500) {
                        var form = $("form#{{ form_system_error }}");
                      } else {
                        var form = $("form#{{ form_server_error }}");
                      }
                      form.submit();
                  },
                  onCancel: function () {
                      /* This function executes when the
                      /* user cancels and closes the window
                      /* and returns to home page. */
                      amplitude.getInstance().logEvent(closedEvent, {status: "cancel", enrollment_method: "{{ enrollment_method }}"});

                      return location.reload();
                  }
              });
          });
      })
      .fail(function(jqxhr, settings, exception) {
        $(".loading").remove();
        console.log(exception);
      });
  </script>

  {% for f in forms %}
    {% include "core/includes/form.html" with form=f %}
  {% endfor %}
{% endblock inner-content %}

{% block call-to-action-button %}
  <button type="button" class="btn btn-primary btn-lg loading" role="status" disabled>{% translate "Please wait..." %}</button>
  <div class="invisible">
    <button id="{{ cta_button }}" href="#{{ cta_button }}" class="btn btn-lg btn-primary" role="button">
      {% translate "Enroll" %}
    </button>
  </div>
{% endblock call-to-action-button %}
