name: "Agency Onboarding Issue Scaffold"

on:
  workflow_dispatch:
    inputs:
      long_name:
        description: "The full name of the transit provider; e.g. California State Transit"
        required: true
        type: string
      short_name:
        description: "The short name / acronym of the transit provider; e.g. CST"
        required: true
        type: string
      transit_processor:
        description: "Which transit processor does this transit provider use?"
        required: true
        type: choice
        options:
          - Littlepay
          - Switchio
      website:
        description: "The full URL (including https://) to the transit provider's website"
        required: false
        type: string
      launch_date:
        description: "Estimated launch date (month and year); e.g. August 2026"
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  scaffold-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parent issue
        id: parent
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const templatePath = '.github/workflows/agency-onboarding/parent.md';
            const { long_name, short_name, transit_processor, website, launch_date } = context.payload.inputs;

            // read body from template, fill in placeholders
            let body = fs.readFileSync(templatePath, 'utf8');
            body = body.replace(/{{LONG_NAME}}/g, long_name)
                       .replace(/{{SHORT_NAME}}/g, short_name)
                       .replace(/{{TRANSIT_PROCESSOR}}/g, transit_processor)
                       .replace(/{{WEBSITE}}/g, website || "N/A")
                       .replace(/{{LAUNCH_DATE}}/g, launch_date || "TBD");

            const response = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Agency onboarding: ${long_name}`,
              labels: ['epic', 'agency-onboarding'],
              body: body
            });

            core.setOutput('node_id', response.data.node_id);
            core.setOutput('issue_number', response.data.number);

      - name: Onboarding form issue
        id: form
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'onboarding-form.md',
              title: `Transit provider has completed their onboarding form`
            });

      - name: Adoption table issue
        id: table
        uses: actions/github-script@v7
        with:
          script: |
            const updateAdoptionTable = require('./.github/workflows/agency-onboarding/adoption-table.js');

            draftPr = await updateAdoptionTable({
              github, context,
              parentIssue: "${{ steps.parent.outputs.issue_number }}"
            });

            core.notice(`Draft PR for updating agency adoption table: ${draftPr.html_url}`);

      - name: Transit processor configuration issue
        id: transit-processor
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');
            const { transit_processor } = context.payload.inputs;

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: `${transit_processor.toLowerCase()}.md`,
              title: `${transit_processor} configuration complete; ready for configuration in Cal-ITP Benefits`
            });

      - name: Production Validation configuration issue
        id: production-validation
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'production-validation.md',
              title: `Transit provider fully configured for Production Validation testing in Cal-ITP Benefits \`test\` environment`
            });

      - name: Test environment configuration issue
        id: test
        uses: actions/github-script@v7
        if: inputs.transit_processor == 'Littlepay'
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'test.md',
              title: `Transit provider fully configured and in Cal-ITP Benefits \`test\` environment`
            });

      - name: Production environment configuration issue
        id: production
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'production.md',
              title: `Transit provider fully configured and active in Cal-ITP Benefits \`production\` environment`
            });

      - name: In-Person Enrollment configuration issue
        id: in-person
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'in-person.md',
              title: `Transit provider is configured for In-Person Enrollments in Benefits Administrator`
            });

      - name: Metabase configuration issue
        id: metabase-config
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'metabase-config.md',
              title: `Add product names to transaction charts in Metabase`
            });

      - name: Amplitude enrollment issue
        id: amplitude-enrollment
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'amplitude.md',
              title: `Amplitude displays one or more successful enrollments for this transit provider`
            });

      - name: Metabase metrics issue
        id: metabase-metrics
        uses: actions/github-script@v7
        with:
          script: |
            const createChild = require('./.github/workflows/agency-onboarding/child-issue.js');

            await createChild({
              github, context, core,
              parentNodeId: "${{ steps.parent.outputs.node_id }}",
              templateName: 'metabase-enrollments.md',
              title: `Metabase metrics display activity for this transit provider`
            });
